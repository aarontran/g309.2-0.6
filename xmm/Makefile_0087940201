
# Must run AFTER sourcing sasinit for this project.
# Must run on statler or other machines (not treble)
# with sufficient RAM, 8GB seems to be enough.

OBSID = 0087940201
REV = 0315
#OBSID = 0551000201
#REV = 1692

MSPRF = 1S001 2S002
PNPRF = S003

# Dependencies, generated by Makefile in $XMM_PATH

INIT = ccf.cif $(REV)_$(OBSID)_SCX00000SUM.SAS
CALDBF = $(XMM_PATH)/caldb/mos1-diag.rsp \
	$(XMM_PATH)/caldb/mos2-diag.rsp \
	$(XMM_PATH)/caldb/pn-diag.rsp

# Expected outputs
.PHONY : fiddle
fiddle : $(foreach prf, $(MSPRF), mos$(prf)-clean.fits) \
    	 $(foreach prf, $(PNPRF), pn$(prf)-clean.fits)

# mos1S001-obj-src-grp.pi
# mos1S001-obj-bkg-grp.pi
# mos2S002-obj-src-grp.pi
# mos2S002-obj-bkg-grp.pi
# pnS003-obj-src-grp.pi
# pnS003-obj-bkg-grp.pi


# Compute QPB for source region
# TODO This depends on a slew of files from mos-spectra
# which I have not specified in the dependencies here!!
# using -obj-src.pi spectrum as "evidence" of successful script build
mos%-back-src.pi : mos%-obj-src.pi
	mos_back prefix=% caldb=$(CALDB) \
		diag=2 elow=0 ehigh=0 \
		ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1 \
	    >& mos_back_%_src.log

pn%-back-src.pi pn%-obj-os-src.pi : pn%-obj-src.pi
	pn_back prefix=% caldb=$(CALDB) \
		diag=2 elow=0 ehigh=0 quad1=1 quad2=1 quad3=1 quad4=1 \
	    >& pn_back_%_src.log

# Spectrum extraction, source region

mos%-obj-src.pi mos%-src.rmf mos%-src.arf : mos%-clean.fits reg_mos%_src.txt $(CALDBF)
	mos-spectra prefix=$* caldb=$(CALDB) region=regm1src.txt \
		mask=0 elow=0 ehigh=0 \
		ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1 \
	    >& mos-spectra_$*_src.log
	mv command.csh mos_spectra_regm1src_cmd.csh

pn%-obj-src.pi pn%-src.rmf pn%-src.arf : pn%-clean.fits reg_pn%_src.txt $(CALDBF)
	pn-spectra prefix=$* caldb=$(CALDB) region=regpnsrc.txt \
	    	mask=0 elow=0 ehigh=0 \
	    	quad1=1 quad2=1 quad3=1 quad4=1 \
	    >& pn-spectra_$*_src.log
	mv command.csh pn_spectra_regpnsrc_cmd.csh

# Good time filtering (remove flares w/ histogram method)


mos%-clean.fits : P$(OBSID)M%MIEVLI0000.FIT
	mv $< mos$*-ori.fits
	touch mos$*-clean.fits
#	mos-filter >& mos-filter.log
#	mv command.csh mos_filter_cmd.csh
#	# Work around Snowden's renaming so dependencies resolve correctly
#	mv mos$*-ori.fits $<
#	ln -s $< mos$*-ori.fits

pn%-clean.fits : P$(OBSID)PN%OOEVLI0000.FIT
	mv $< pn$*-ori.fits
	touch pn$*-clean.fits
#	pn-filter >& pn-filter.log
#	# no command.csh is generated by pn-filter, unlike mos-filter.
#	# Work around Snowden's renaming so dependencies resolve correctly
#	mv pn$*-ori.fits $<
#	ln -s $< pn$*-ori.fits

# Generate event lists

P$(OBSID)M%MIEVLI0000.FIT : $(INIT)
	emchain >& emchain.log
#	touch P$(OBSID)M1S001MIEVLI0000.FIT
#	touch P$(OBSID)M2S002MIEVLI0000.FIT

# Mode (imaging, PIEVLI) hard-coded in filenames, may change for other cases.
P$(OBSID)PN%PIEVLI0000.FIT : $(INIT) P$(OBSID)PN%OOEVLI0000.FIT
	epchain >& epchain.log
#	touch P$(OBSID)PNS003PIEVLI0000.FIT

P$(OBSID)PN%OOEVLI0000.FIT : $(INIT)
	epchain withoutoftime=true >& epchain_oot.log
#	touch P$(OBSID)PNS003OOEVLI0000.FIT

