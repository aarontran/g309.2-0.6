#!/bin/bash

# Create full FOV images in multiple energy bands.

# For reference, the ESAS soft proton energy bands are:
# 300-750, 750-1250, 1250-2000, 2000-4000, 4000-8000, 8000-12000 (eV)

# One broad band, three narrow line bands (Mg, Si, S), four continuum bands
PI_MINS=( "800" "1300" "1800" "2400" "1150" "1600" "1980" "2600")
PI_MAXS=("3300" "1400" "1900" "2500" "1250" "1650" "2050" "2700")

# Bands manually chosen by inspecting integrated source spectra:
# $ xs_replotter.py replot_src_bkg.yaml
#
# Si 1.8-1.9 is a narrow cut that misses a lot of Si flux.
# Same for S 2.4-2.5, Mg 1.3-1.4.  But, this avoids instrumental lines
# and should yield reasonable signal/noise.
#
# 0087940201 PN could benefit from broader line cuts.
# 0551000201 MOS could tweak Si to avoid bright instrumental line.
# Do make images with MOS only, then add PN.

CALDB="${XMM_PATH}/caldb"

if [[ "$SAS_OBSID" == "0087940201" ]]; then

  exps=("mos1S001" "mos2S002" "pnS003")
  exps_n=("1S001" "2S002" "S003")
  ccd_strs=("ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1" \
            "ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1" \
            "quad1=1 quad2=1 quad3=1 quad4=1")
  # s/quad/ccd/ for proton task
  proton_ccd_strs=("ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1" \
                   "ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=1 ccd7=1" \
                   "ccd1=1 ccd2=1 ccd3=1 ccd4=1")
  # Assumes unbroken power law;
  # bkg_pnorms, pindices taken from 20161015_src_bkg_mg.log
  bkg_pnorms=("0.0587213" "0.0587213" "0.0663454")
  pindices=("0.355124" "0.355124" "0.253715")
  # pnorm = sp_partial_factor * bkg_pnorm
  pnorms=("0.2567173" "0.2552315" "0.2936542")

elif [[ "$SAS_OBSID" == "0551000201" ]]; then

  # Skip pnS003, large window mode has no corner data to use
  exps=("mos1S001" "mos2S002")
  exps_n=("1S001" "2S002")
  # 0551000201 MOS1 CCD6 = 0 (destroyed), MOS2 CCD5 = 0 (anomalous state)
  ccd_strs=("ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=1 ccd6=0 ccd7=1" \
            "ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=0 ccd6=1 ccd7=1")
  proton_ccd_strs=$ccd_strs
  # Assumes power law
  # bkg_pnorms, pindices taken from 20161015_src_bkg_mg.log
  bkg_pnorms=("0.0243880" "0.0243880")
  pindices=("0.488202" "0.488202")
  pnorms=("0.079018742" "0.077613033")

else

  echo "ERROR: unsupported obsid $SAS_OBSID (pipeline not set up)"
  exit 1

fi

for ((i=0;i<${#PI_MINS[@]};++i)); do

  elow="${PI_MINS[$i]}"
  ehigh="${PI_MAXS[$i]}"

  cd $SAS_REPRO
  echo "Extracting $SAS_OBSID images in ${elow}-${ehigh} eV range"
  start_script="Start: $(date)"
  echo $start_script

  for ((j=0;j<${#exps[@]};++j)); do

    # Setup
    # -----
    exp="${exps[$j]}"     # mos1S001
    exp_n="${exps_n[$j]}" # 1S001
    ccd_str="${ccd_strs[$j]}" # "ccd1=1 ccd2=1 ... ccd7=1"
    proton_ccd_str="${proton_ccd_strs[$j]}"
    bkg_pnorm="${bkg_pnorms[$j]}"
    pindex="${pindices[$j]}"
    pnorm="${pnorms[$j]}"
    # Do not quote ${ccd_str} in command invocations!

    echo "i = $i, j = $j"
    echo "Operating on $exp ($exp_n)"
    echo "CCD selection: $ccd_str"
    echo "Proton CCD selection: $proton_ccd_str"
    echo "Proton parameters: bkg_pnorm=$bkg_pnorm, index=$pindex, pnorm=$pnorm"

    if [[ $exp =~ "mos" ]]; then
      exe_spec="mos-spectra-mod"
      exe_qpb="mos_back"
    elif [[ $exp =~ "pn" ]]; then
      exe_spec="pn-spectra-mod"
      exe_qpb="pn_back"
    else
      echo "ERROR: Got bad exposure string $exp"
      exit 1
    fi

    # Extraction
    # ----------
    echo "  Running ${exe_spec} prefix=${exp_n} elow=${elow} ehigh=${ehigh}..."
    ${exe_spec} prefix=${exp_n} region="" caldb="${CALDB}" \
        mask=1 elow=${elow} ehigh=${ehigh} ${ccd_str} \
      &> "${exe_spec}_${exp}_FOV_${elow}_${ehigh}.log"
    mv command.csh "${exe_spec}_${exp}_FOV_${elow}_${ehigh}_cmd.csh"

    echo "  Running ${exe_qpb}..."
    ${exe_qpb} prefix=${exp_n} caldb="${CALDB}" diag=2 clobber=1 \
        elow=${elow} ehigh=${ehigh} ${ccd_str} \
      &> "${exe_qpb}_${exp}_FOV_${elow}_${ehigh}.log"
    # diag=2 creates more diagnostic output files (.qdp plots)
    # Rotate SP image
    rot-im-det-sky prefix=${exp_n} elow=${elow} ehigh=${ehigh} mode=1 \
      &> "rot-im-det-sky_${exp}_FOV_${elow}_${ehigh}_mode-1.log"

    echo "  Rename output files (map ${exp} to ${exp}-FOV)"
    # Note: many outputs below are from "-mod" ESAS scripts only:
    # WARNING: these file names should be kept consistent
    # with "specbackgrp" as much as possible
    mv "${exp}-obj.pi"      "${exp}-FOV.pi"
    mv "${exp}-back.pi"     "${exp}-FOV-qpb.pi"
    mv "${exp}.rmf"         "${exp}-FOV.rmf"
    mv "${exp}.arf"         "${exp}-FOV.arf"
    mv "${exp}.flatrmf"     "${exp}-FOV.flatrmf"
    mv "${exp}.flatarf"     "${exp}-FOV.flatarf"
    mv "${exp}-obj-ff.pi"   "${exp}-FOV-ff.pi"
    mv "${exp}-ff.arf"      "${exp}-FOV-ff.arf"
    mv "${exp}-ff.rmf"      "${exp}-FOV-ff.rmf"
    mv "${exp}-obj-im-sp-det.fits" "${exp}-FOV-im-sp.fits"
    if [[ "$exp" =~ "pn" ]]; then
      mv "${exp}-obj-oot.pi"    "${exp}-FOV-oot.pi"
      mv "${exp}-obj-os.pi"     "${exp}-FOV-os.pi"
      mv "${exp}-obj-ff-oot.pi" "${exp}-FOV-ff-oot.pi"
      # No OOT subtraction is done for PN FWC spectra
    fi


    # Soft proton
    # -----------
    # Bootstrapping issue: sp_partial must be run BEFORE proton
    # Requires -bkg.pi spectrum to have been extracted.
    # kind of a pain, but OK.

    # proton and swcx tasks only operate on files named "elow", "ehigh"
    # and so can be run after the above renaming.

    if [[ $exp =~ "mos1" ]]; then
      detector_n=1
    elif [[ $exp =~ "mos2" ]]; then
      detector_n=1
    elif [[ $exp =~ "pn" ]]; then
      detector_n=3
    fi

    echo "  Running sp_partial prefix=${exp_n} with rnorm=${bkg_pnorm}..."
    sp_partial caldb=${CALDB} detector=${detector_n} \
        fullimage="${exp}-FOV-im-sp.fits" fullspec="${exp}-FOV.pi" \
        regionimage="${exp}-bkg-im-sp.fits" regionspec="${exp}-bkg.pi" \
        rnorm=${bkg_pnorm} \
      &> "sp_partial_${exp}_FOV_${elow}_${ehigh}.log"

    echo "  Running proton prefix=${exp_n}..."
    proton prefix=${exp_n} caldb="${CALDB}" specname="${exp}-FOV.pi" \
        elow=${elow} ehigh=${ehigh} ${proton_ccd_str} \
        pindex=${pindex} pnorm=${pnorm} spectrumcontrol=1 \
      &> "proton_${exp}_FOV_${elow}_${ehigh}.log"
    # Rotate proton image
    rot-im-det-sky prefix=${exp_n} elow=${elow} ehigh=${ehigh} mode=2 \
      &> "rot-im-det-sky_${exp}_FOV_${elow}_${ehigh}_mode-2.log"

  done

  echo "Finished extracting $SAS_OBSID images in ${elow}-${ehigh} eV range"
  echo $start_script
  echo "Finished: $(date)"
done

