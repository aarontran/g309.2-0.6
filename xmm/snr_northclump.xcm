# Thing thing thing

# Trying to generalize...
# 1. write your n=1 case, before you try to refactor all of this.
# adopted from snr_and_back.xcm

setplot en ; abund wilm ; query yes ; cpd /xw

# Data import + response set-up (sub-source)
# --------------------------------------

data 1:1 0087940201/odf/repro/mos1S001-src_north_clump-grp50.pi 
data 2:2 0087940201/odf/repro/mos2S002-src_north_clump-grp50.pi 
data 3:3 0087940201/odf/repro/pnS003-src_north_clump-os-grp50.pi
data 4:4 0551000201/odf/repro/mos1S001-src_north_clump-grp50.pi 
data 5:5 0551000201/odf/repro/mos2S002-src_north_clump-grp50.pi 

resp 1 0087940201/odf/repro/mos1S001-src_north_clump.rmf
resp 2 0087940201/odf/repro/mos2S002-src_north_clump.rmf
resp 3 0087940201/odf/repro/pnS003-src_north_clump.rmf
resp 4 0551000201/odf/repro/mos1S001-src_north_clump.rmf
resp 5 0551000201/odf/repro/mos2S002-src_north_clump.rmf

arf 1 0087940201/odf/repro/mos1S001-src_north_clump.arf
arf 2 0087940201/odf/repro/mos2S002-src_north_clump.arf
arf 3 0087940201/odf/repro/pnS003-src_north_clump.arf
arf 4 0551000201/odf/repro/mos1S001-src_north_clump.arf
arf 5 0551000201/odf/repro/mos2S002-src_north_clump.arf

back 1 0087940201/odf/repro/mos1S001-src_north_clump-qpb.pi
back 2 0087940201/odf/repro/mos2S002-src_north_clump-qpb.pi
back 3 0087940201/odf/repro/pnS003-src_north_clump-qpb.pi
back 4 0551000201/odf/repro/mos1S001-src_north_clump-qpb.pi
back 5 0551000201/odf/repro/mos2S002-src_north_clump-qpb.pi

# response set-up (background)
# ------------------------------------------
# 1: x-ray background
# 2: instrumental lines
# 3: SNR plasma model
# 4: soft proton background, background

resp 2:1 0087940201/odf/repro/mos1S001-src_north_clump.rmf
arf  2:1 0087940201/odf/repro/mos1S001-src_north_clump-ff.arf 
resp 3:1 0087940201/odf/repro/mos1S001-src_north_clump.rmf
arf  3:1 0087940201/odf/repro/mos1S001-src_north_clump.arf
resp 4:1 caldb/mos1-diag.rsp 
arf  4:1 none

resp 2:2 0087940201/odf/repro/mos2S002-src_north_clump.rmf
arf  2:2 0087940201/odf/repro/mos2S002-src_north_clump-ff.arf 
resp 3:2 0087940201/odf/repro/mos2S002-src_north_clump.rmf
arf  3:2 0087940201/odf/repro/mos2S002-src_north_clump.arf
resp 4:2 caldb/mos2-diag.rsp 
arf  4:2 none

resp 2:3 0087940201/odf/repro/pnS003-src_north_clump.rmf
arf  2:3 0087940201/odf/repro/pnS003-src_north_clump-ff.arf 
resp 3:3 0087940201/odf/repro/pnS003-src_north_clump.rmf
arf  3:3 0087940201/odf/repro/pnS003-src_north_clump.arf
resp 4:3 caldb/pn-diag.rsp 
arf  4:3 none

resp 2:4 0551000201/odf/repro/mos1S001-src_north_clump.rmf
arf  2:4 0551000201/odf/repro/mos1S001-src_north_clump-ff.arf 
resp 3:4 0551000201/odf/repro/mos1S001-src_north_clump.rmf
arf  3:4 0551000201/odf/repro/mos1S001-src_north_clump.arf
resp 4:4 caldb/mos1-diag.rsp 
arf  4:4 none

resp 2:5 0551000201/odf/repro/mos2S002-src_north_clump.rmf
arf  2:5 0551000201/odf/repro/mos2S002-src_north_clump-ff.arf 
resp 3:5 0551000201/odf/repro/mos2S002-src_north_clump.rmf
arf  3:5 0551000201/odf/repro/mos2S002-src_north_clump.arf
resp 4:5 caldb/mos2-diag.rsp 
arf  4:5 none



# XRB parameters from combined SNR+bkg fit with XRB nH = 0.9
# and all SP indices varying freely
model  1:xrb constant*(apec + tbabs(powerlaw + apec))
    1
    0.204483
    1
    0
    3.06343E-04
    0.9
    1.40
    3.68136E-04
    0.350698
    1
    0
    2.83742E-03

# Set backscale values
## src_north_clump backscal values:
newpar xrb:1   0.214617029868049
newpar xrb:13  0.207496737049146
newpar xrb:25  0.201593257870811
newpar xrb:37  0.203098201143661
newpar xrb:49  0.205135376639617
## src_E_lobe backscal values:
#newpar xrb:1   0.0959036615388623
#newpar xrb:13  0.0976274895468341
#newpar xrb:25  0.0962834924646025
#newpar xrb:37  0.0826340675515494
#newpar xrb:49  0.0955201834025869
## src_SE_dark backscal values:
#newpar xrb:1   0.115917520938896
#newpar xrb:13  0.113678863112373
#newpar xrb:25  0.116430162431126
#newpar xrb:37  0.120053978715921
#newpar xrb:49  0.123154680803949
## src_SW_lobe backscal values:
#newpar xrb:1   0.175711609852679
#newpar xrb:13  0.174055307342616
#newpar xrb:25  0.165832462778914
#newpar xrb:37  0.17357689752641
#newpar xrb:49  0.173631136757369

freeze xrb:*


# XMM EPIC instrumental lines
# ---------------------------
model  2:instr con*(gauss + gauss + gauss + gauss + gauss + gauss)
    1
    1.49
    0
    0
    1.75
    0
    0
    7.49
    0
    0
    8.05
    0
    0
    8.62
    0
    0
    8.90
    0
    0

# Set line constants (to float)
newpar instr:1  1
newpar instr:20 1
newpar instr:39 1
newpar instr:58 1
newpar instr:77 1

#0087940201 mos1S001 src_north_clump FWC instrumental line norms:
newpar instr:4   0.00860299
newpar instr:7   0.00387235
#0087940201 mos2S002 src_north_clump FWC instrumental line norms:
newpar instr:23  0.0086138
newpar instr:26  0.00365742
#0087940201 pnS003 src_north_clump FWC instrumental line norms:
newpar instr:42  0.00736336
newpar instr:45  0
newpar instr:48  0.000111586
newpar instr:51  0.00527102
newpar instr:54  0.00362706
newpar instr:57  0.000982332
#0551000201 mos1S001 src_north_clump FWC instrumental line norms:
newpar instr:61  0.0074413
newpar instr:64  0.00453339
#0551000201 mos2S002 src_north_clump FWC instrumental line norms:
newpar instr:80  0.00752625
newpar instr:83  0.00455994

freeze instr:*
thaw instr:1,20,39,58,77

## TODO WARNING: pnS003 shows very clear unmodeled lines around
## 4.5 keV, 5.2 keV ish.  (Ti, Cr???)
## ignore 4-6 keV in PNS003 for now....


# SUPERNOVA REMNANT
# -----------------
# 1 = TBabs nH
# 2 = vnei kT
# 3-15 = vnei abundances (H,He,C,...,Ni); 10=Si, 11=S
# 16 = vnei Tau
# 17 = vnei redshift
# 18 = vnei norm
mo 3:snr tbabs*vnei
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1e11
    0
    1

freeze snr:1,2,16

# Soft proton contamination
# -------------------------
# Don't link between instruments (per ESAS cookbook).
# At most, maybe we can link the power-law between MOS1 and MOS2
# But even then, because we're sampling different distances from optical axis
# etc., likely to differ.  So best to let float...
model 4:sp po*con
    0.4
    1e-2
    1

# For initial fit, don't let the power law index vary
newpar sp:1 0.4
newpar sp:4 0.4
newpar sp:7 0.4
newpar sp:10 0.4
newpar sp:13 0.4

# Let all norms vary independently
newpar sp:2 1e-2
newpar sp:5 1e-2
newpar sp:8 1e-2
newpar sp:11 1e-2
newpar sp:14 1e-2

# Apply backscal ratio constants
# SRC_NORTH_CLUMP ONLY
newpar sp:3   0.214617029868049
newpar sp:6   0.207496737049146
newpar sp:9   0.201593257870811
newpar sp:12  0.203098201143661
newpar sp:15  0.205135376639617

# Freeze all but norms for initial fit
freeze sp:*
thaw sp:2,5,8,11,14

# Prepare to fit
# --------------
notice all
ignore **:**-0.3,11.0-**
# Ignore 0.3-0.4 keV for PN
ignore 3:**-0.4

# TODO temporary src_north_clump only
ignore 3:4.0-6.0
# Obviously unmodeled lines.

# Start iterative fitting
# -----------------------

renorm
# chisqr/dof = 15519/675 = 22.99

# Let SP power laws float
thaw sp:1,4,7,10,13
# tie MOS1/2 sp indices
newpar sp:4=sp:1
newpar sp:13=sp:10
fit
# chisqr/dof = 10115/672 = 15.05

# Let SNR nH, kT, Tau float
thaw snr:1,2,16
fit
# chisqr/dof = 2412/669 = 3.606

# Iteratively thaw Si,S abundances (confirming presence or absence of lines by eye)
pl ld delch
thaw snr:10
fit
# chisqr/dof = 1404/668 = 2.102
pl ld delch
thaw snr:11
fit
# chisqr/dof = 847.4/667 = 1.270


# Fit looks quite acceptable at this point.
# Below: commented sections should be run from this "acceptable" fit,
# as the jumping-off point.

# * Thawing iron marginally improves the fit
# thaw snr:14 ; fit
# chisqr/dof = 832.5/666 = 1.250

# * Forcing magnesium to 0.1 worsens fit significantly
# newpar snr:9 0.1 ; fit
# chisqr/dof = 1136.25/667 = 1.704

# * Thawing magnesium changes fit a lot, but doesn't necessarily improve fit
# thaw snr:9 ; fit
# chisqr/dof = 842.2/666 = 1.265

# (in fact, thawing iron and allowing its abundance to drop has larger effect
# on fit)
# Fit parameters shift somewhat:
# nH = 2.83
# kT = 0.87
#   Mg -> 1.2
#   Si -> 5.33
#   S -> 5.07
# Tau = 6.66e+10

# * Thawing both magnesium and iron results in a slightly improved fit
#   but, quite marginal...
# thaw snr:9 ; thaw snr:14 ; fit
# chisqr/dof = 830.59/665 = 1.249





