# Script to fit source and background regions simultaneously
# for 0087940201 (all exposures) and 0551000201 (MOS1,2 only)

# Normalizations for instrumental lines hardcoded, entered by hand
# Background parameters hardcoded, entered by hand

#cpd /xw
setplot en
abund wilm
query yes

# Data import + response set-up (source)
# --------------------------------------

data 1:1 0087940201/odf/repro/mos1S001-src-grp50.pi 
data 2:2 0087940201/odf/repro/mos2S002-src-grp50.pi 
data 3:3 0087940201/odf/repro/pnS003-src-os-grp50.pi
data 4:4 0551000201/odf/repro/mos1S001-src-grp50.pi 
data 5:5 0551000201/odf/repro/mos2S002-src-grp50.pi 

resp 1 0087940201/odf/repro/mos1S001-src.rmf
resp 2 0087940201/odf/repro/mos2S002-src.rmf
resp 3 0087940201/odf/repro/pnS003-src.rmf
resp 4 0551000201/odf/repro/mos1S001-src.rmf
resp 5 0551000201/odf/repro/mos2S002-src.rmf

arf 1 0087940201/odf/repro/mos1S001-src.arf
arf 2 0087940201/odf/repro/mos2S002-src.arf
arf 3 0087940201/odf/repro/pnS003-src.arf
arf 4 0551000201/odf/repro/mos1S001-src.arf
arf 5 0551000201/odf/repro/mos2S002-src.arf

back 1 0087940201/odf/repro/mos1S001-src-qpb.pi
back 2 0087940201/odf/repro/mos2S002-src-qpb.pi
back 3 0087940201/odf/repro/pnS003-src-qpb.pi
back 4 0551000201/odf/repro/mos1S001-src-qpb.pi
back 5 0551000201/odf/repro/mos2S002-src-qpb.pi

# Data import + response set-up (background)
# ------------------------------------------

data 6:6 0087940201/odf/repro/mos1S001-bkg-grp50.pi
data 7:7 0087940201/odf/repro/mos2S002-bkg-grp50.pi
data 8:8 0087940201/odf/repro/pnS003-bkg-os-grp50.pi
data 9:9 0551000201/odf/repro/mos1S001-bkg-grp50.pi
data 10:10 0551000201/odf/repro/mos2S002-bkg-grp50.pi

resp 6 0087940201/odf/repro/mos1S001-bkg.rmf
resp 7 0087940201/odf/repro/mos2S002-bkg.rmf
resp 8 0087940201/odf/repro/pnS003-bkg.rmf
resp 9 0551000201/odf/repro/mos1S001-bkg.rmf
resp 10 0551000201/odf/repro/mos2S002-bkg.rmf

arf  6 0087940201/odf/repro/mos1S001-bkg.arf
arf  7 0087940201/odf/repro/mos2S002-bkg.arf
arf  8 0087940201/odf/repro/pnS003-bkg.arf
arf  9 0551000201/odf/repro/mos1S001-bkg.arf
arf 10 0551000201/odf/repro/mos2S002-bkg.arf

back 6 0087940201/odf/repro/mos1S001-bkg-qpb.pi
back 7 0087940201/odf/repro/mos2S002-bkg-qpb.pi
back 8 0087940201/odf/repro/pnS003-bkg-qpb.pi
back 9 0551000201/odf/repro/mos1S001-bkg-qpb.pi
back 10 0551000201/odf/repro/mos2S002-bkg-qpb.pi

# response set-up (background)
# ------------------------------------------

# 1: x-ray background
# 2: instrumental lines
# 3: SNR plasma model
# 4: soft proton background, background

## 0087940201 exposures, src region

# resp 1:1 0087940201/odf/repro/mos1S001-src.rmf
# arf  1:1 0087940201/odf/repro/mos1S001-src.arf
resp 2:1 0087940201/odf/repro/mos1S001-src.rmf
arf  2:1 0087940201/odf/repro/mos1S001-src-ff.arf
resp 3:1 0087940201/odf/repro/mos1S001-src.rmf
arf  3:1 0087940201/odf/repro/mos1S001-src.arf
resp 4:1 caldb/mos1-diag.rsp 
arf  4:1 none

# resp 1:2 0087940201/odf/repro/mos2S002-src.rmf
# arf  1:2 0087940201/odf/repro/mos2S002-src.arf
resp 2:2 0087940201/odf/repro/mos2S002-src.rmf
arf  2:2 0087940201/odf/repro/mos2S002-src-ff.arf
resp 3:2 0087940201/odf/repro/mos2S002-src.rmf
arf  3:2 0087940201/odf/repro/mos2S002-src.arf
resp 4:2 caldb/mos2-diag.rsp 
arf  4:2 none

# resp 1:3 0087940201/odf/repro/pnS003-src.rmf
# arf  1:3 0087940201/odf/repro/pnS003-src.arf
resp 2:3 0087940201/odf/repro/pnS003-src.rmf
arf  2:3 0087940201/odf/repro/pnS003-src-ff.arf
resp 3:3 0087940201/odf/repro/pnS003-src.rmf
arf  3:3 0087940201/odf/repro/pnS003-src.arf
resp 4:3 caldb/pn-diag.rsp 
arf  4:3 none

## 0551000201 exposures, src region

# resp 1:4 0087940201/odf/repro/mos1S001-src.rmf
# arf  1:4 0087940201/odf/repro/mos1S001-src.arf
resp 2:4 0551000201/odf/repro/mos1S001-src.rmf
arf  2:4 0551000201/odf/repro/mos1S001-src-ff.arf
resp 3:4 0551000201/odf/repro/mos1S001-src.rmf
arf  3:4 0551000201/odf/repro/mos1S001-src.arf
resp 4:4 caldb/mos1-diag.rsp 
arf  4:4 none

# resp 1:5 0087940201/odf/repro/mos2S002-src.rmf
# arf  1:5 0087940201/odf/repro/mos2S002-src.arf
resp 2:5 0551000201/odf/repro/mos2S002-src.rmf
arf  2:5 0551000201/odf/repro/mos2S002-src-ff.arf
resp 3:5 0551000201/odf/repro/mos2S002-src.rmf
arf  3:5 0551000201/odf/repro/mos2S002-src.arf
resp 4:5 caldb/mos2-diag.rsp 
arf  4:5 none

## 0087940201 exposures, bkg region

#resp 1:6 0087940201/odf/repro/mos1S001-bkg.rmf
#arf  1:6 0087940201/odf/repro/mos1S001-bkg.arf
resp 2:6 0087940201/odf/repro/mos1S001-bkg.rmf
arf  2:6 0087940201/odf/repro/mos1S001-bkg-ff.arf
resp 4:6 caldb/mos1-diag.rsp
arf  4:6 none

#resp 1:7 0087940201/odf/repro/mos2S002-bkg.rmf
#arf  1:7 0087940201/odf/repro/mos2S002-bkg.arf
resp 2:7 0087940201/odf/repro/mos2S002-bkg.rmf
arf  2:7 0087940201/odf/repro/mos2S002-bkg-ff.arf
resp 4:7 caldb/mos2-diag.rsp
arf  4:7 none

#resp 1:8 0087940201/odf/repro/pnS003-bkg.rmf
#arf  1:8 0087940201/odf/repro/pnS003-bkg.arf
resp 2:8 0087940201/odf/repro/pnS003-bkg.rmf
arf  2:8 0087940201/odf/repro/pnS003-bkg-ff.arf
resp 4:8 caldb/pn-diag.rsp
arf  4:8 none

## 0551000201 exposures, bkg region

#resp 1:9 0551000201/odf/repro/mos1S001-bkg.rmf
#arf  1:9 0551000201/odf/repro/mos1S001-bkg.arf
resp 2:9 0551000201/odf/repro/mos1S001-bkg.rmf
arf  2:9 0551000201/odf/repro/mos1S001-bkg-ff.arf
resp 4:9 caldb/mos1-diag.rsp
arf  4:9 none

#resp 1:10 0551000201/odf/repro/mos2S002-bkg.rmf
#arf  1:10 0551000201/odf/repro/mos2S002-bkg.arf
resp 2:10 0551000201/odf/repro/mos2S002-bkg.rmf
arf  2:10 0551000201/odf/repro/mos2S002-bkg-ff.arf
resp 4:10 caldb/mos2-diag.rsp
arf  4:10 none

# Model parameter set-up
# ----------------------
# Note: keep model definition + initial freeze/thaw commands together
# That way, easier to mentally link parameters and their numbers

# Sky X-ray background
# --------------------
# apec is: kT, abund, redshift, norm
model  1:xrb constant*(apec + tbabs(powerlaw + apec))
    1
    0.1
    1
    0
    2e-5
    1
    1.4
    1e-5
    0.25
    1
    0
    1e-4

# Scale BACKSCAL values to 0087940201 MOS1S001 src region
# to get XRB normalizations right, across regions AND exposures
# src region exposures
newpar xrb:1  1
newpar xrb:13 0.990
newpar xrb:25 0.935
newpar xrb:37 0.885
newpar xrb:49 0.982
# bkg region exposures
newpar xrb:61  1.017
newpar xrb:73  1.043
newpar xrb:85  0.956
newpar xrb:97  1.151
newpar xrb:109 1.261
# Note: this effect could also affect src region fits.
# BUT, due to spatial structure of SNR + smaller variation between src regions
# between exposures (vs. sky expected to be ~constant everywhere),
# we neglect this discrepancy.  Most strongly affects 0087940201 PNS003 (large
# column exclusions) and 0551000201 MOS1S001 (one missing CCD).
# 0551000201 MOS2S002 has CCD5 removed, but this only affects the background
# region; src is totally unscathed.

freeze xrb:1,13,25,37,49, 61,73,85,97,109

# Freeze key physical parameters to reasonable starting values:
# unabsorped apec kT (local hot bubble / heliospheric stuff), absorption nH,
# power-law index, and absorbed apec kT
freeze xrb:2,6,7,9


# XMM EPIC instrumental lines
# ---------------------------
model  2:instr con*(gauss + gauss + gauss + gauss + gauss + gauss)
    1
    1.49
    0
    0
    1.75
    0
    0
    7.49
    0
    0
    8.05
    0
    0
    8.62
    0
    0
    8.90
    0
    0

# Set MOS1 line constant, normalizations (mos1 src, ff)
newpar instr:1 1
newpar instr:4 4.146e-2
newpar instr:7 1.285e-2
# Set MOS2 line constant, normalizations (mos2 src, ff)
newpar instr:20 1
newpar instr:23 4.531e-2
newpar instr:26 1.182e-2
# Set PN line constant, normalizations (pn src, ff); zero Si (1.75 keV) line
newpar instr:39 1
newpar instr:42 3.348e-2
newpar instr:45 0
newpar instr:48 1.236e-2
newpar instr:51 8.820e-2
newpar instr:54 1.850e-2
newpar instr:57 1.091e-2
# Set 0551000201 MOS1 line constant, norm (mos1 src, ff)
newpar instr:58 1
newpar instr:61 3.340e-2
newpar instr:64 2.004e-2
# Set 0551000201 MOS2 line constant, norm (mos1 src, ff)
newpar instr:77 1
newpar instr:80 3.866e-2
newpar instr:83 2.021e-2

# Set MOS1 line constant, normalizations (mos1 bkg, ff)
newpar instr:96 1
newpar instr:99 4.667e-2
newpar instr:102 8.893e-3
# Set MOS2 line constant, normalizations (mos2 bkg, ff)
newpar instr:115 1
newpar instr:118 4.975e-2
newpar instr:121 9.341e-3
# Set PN line constant, normalizations (pn bkg, ff); zero Si (1.75 keV) line
newpar instr:134 1
newpar instr:137 3.435e-2
newpar instr:140 0
newpar instr:143 1.511e-2
newpar instr:146 0.126
newpar instr:149 2.031e-2
newpar instr:152 1.653e-2

# Set MOS1(motch) line constant, normalizations (mos1 bkg, ff)
newpar instr:153 1
newpar instr:156 6.046e-2
newpar instr:159 3.386e-3
# Set MOS2(motch) line constant, normalizations (mos2 bkg, ff)
newpar instr:172 1
newpar instr:175 6.427e-2
newpar instr:178 5.218e-3

# Freeze all the line normalizations; let constant vary
# (essentially freezing all line ratios)
freeze instr:1-190
thaw instr:1,20,39,58,77, 96,115,134,153,172

# SUPERNOVA REMNANT
# -----------------
# 1 = TBabs nH
# 2 = vnei kT
# 3-15 = vnei abundances (H,He,C,...,Ni); 10=Si, 11=S
# 16 = vnei Tau
# 17 = vnei redshift
# 18 = vnei norm
mo 3:snr tbabs*vnei
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1e11
    0
    1

# Hold to defaults for initial fit, before varying vnei/tbabs parameters
freeze snr:1,2,16

# Soft proton contamination
# -------------------------
# Don't link between instruments (per ESAS cookbook).
# At most, maybe we can link the power-law between MOS1 and MOS2
# But even then, because we're sampling different distances from optical axis
# etc., likely to differ.  So best to let float...
model 4:sp po*con
    0.4
    1e-2
    1

# For initial fit, don't let the power law index vary
newpar sp:1 0.4
newpar sp:4 0.4
newpar sp:7 0.4
newpar sp:10 0.4
newpar sp:13 0.4
newpar sp:16 0.4
newpar sp:19 0.4
newpar sp:22 0.4
newpar sp:25 0.4
newpar sp:28 0.4
freeze sp:1,4,7,10,13, 16,19,22,25,28

# Let all norms vary independently
newpar sp:2 1e-2
newpar sp:5 1e-2
newpar sp:8 1e-2
newpar sp:11 1e-2
newpar sp:14 1e-2
newpar sp:17 1e-2
newpar sp:20 1e-2
newpar sp:23 1e-2
newpar sp:26 1e-2
newpar sp:29 1e-2

# Apply BACKSCAL ratios w.r.t. 0087940201 MOS1 src region to allow
# easier comparison of normalizations. expect slightly larger in src region
# due to sharp vignetting peak; note we do not use a detector ARF, as
# effects accounted for by ARF are irrelevant.
# src region exposures
newpar sp:3 1
newpar sp:6 0.990
newpar sp:9 0.935
newpar sp:12 0.885
newpar sp:15 0.982
# bkg region exposures
newpar sp:18 1.017
newpar sp:21 1.043
newpar sp:24 0.956
newpar sp:27 1.151
newpar sp:30 1.261
# constants should never be freed
freeze sp:3,6,9,12,15, 18,21,24,27,30


# Prepare to fit
# --------------
notice all
ignore **:**-0.3,11.0-**
# Ignore 0.3-0.4 keV for PN
ignore 3:**-0.4
ignore 8:**-0.4

# xrb, 3 norms (apec, powerlaw, apec)
# instr lines, 10 constants
# soft proton, 10 norms
# SNR, 1 norm
renorm
# chi-squared/dof after renorm = 86300 / 3785? = ?

thaw sp:1,4,7,10,13,16,19,22,25,28
# tie MOS1/2 sp indices
newpar sp:4=sp:1
newpar sp:13=sp:10
newpar sp:19=sp:16
newpar sp:28=sp:25
# PN background index tends to blow up-- freeze to 0.2
##########newpar sp:22 0.2
##########freeze sp:22
##########fit
########### chi-squared/dof after SP fit = 17762 / 3775 = 4.71
##########
########### Note: at this point, SP PN for background has an index that's going nuts
##########
##########thaw snr:1,2,16
##########fit
########### chi-squared/dof after fit with kT,nH,Tau free = 6924 / 3772 = 1.84
##########thaw snr:10,11
##########fit
########### chi-squared/dof after fit with kT,nH,Tau,Si,S free = 4881 / 3770 = 1.29
##########
##########thaw xrb:2,6,9
##########fit
# chi-squared/dof after fit with xrb free = 4630 / 3768 = 1.29
# (note, here I tied PN SP index)

# =========================================================================
# Current fit, after straight up run on evening Feb 19 -- disagrees with my
# comments somewhat.  Trying to replicate previous fit.
#    Test statistic : Chi-Squared =        4632.02 using 3805 PHA bins.
#     Reduced chi-squared =        1.22930 for   3768 degrees of freedom 
#     Null hypothesis probability =   7.886484e-21
# XRB values are a little funky: nH kind of small
# (but, we don't have sense of physical constraint on this anyways)
# and unabsorbed (local) kT ~ 0.1 instead of ~0.2
# absorbed kT 0.3 instead of 0.37; nH ~ 0.29 instead of 1.1
# OK: values are not unreasonable.  But nH is rather small for sightline of galactic halo
# through galactic plane...
#   1    1   constant   factor              0.983000     frozen
#   2    2   apec       kT         keV      0.102175     +/-  5.76049E-03  
#   3    2   apec       Abundanc            1.00000      frozen
#   4    2   apec       Redshift            0.0          frozen
#   5    2   apec       norm                6.64589E-04  +/-  1.19434E-04  
#   6    3   TBabs      nH         10^22    0.286894     +/-  3.95274E-02  
#   7    4   powerlaw   PhoIndex            1.40000      frozen
#   8    4   powerlaw   norm                3.34324E-04  +/-  1.02644E-05  
#   9    5   apec       kT         keV      0.292553     +/-  7.29825E-03  
#  10    5   apec       Abundanc            1.00000      frozen
#  11    5   apec       Redshift            0.0          frozen
#  12    5   apec       norm                7.19190E-04  +/-  1.37734E-04 
#
# As I noted before, PN soft proton index for src region has gone nuts.
# So go ahead and freeze / refit.
#
# newpar sp:7 0.2 ; freeze sp:7 ; fit
# #### chisqr/dof = 4644/3769 = 1.232
#
# newpar xrb:2 0.2 ; freeze xrb:2; fit
# #### chisqr/dof = 4605/3770 = 1.222  (marginal improvement!)
# thaw xrb:2 ; fit
# #### chisqr/dof = 4600/3769 = 1.220
#
# OK, fit has absorbed kT blowing up to 0.77 keV like previously observed
# So...
#
# newpar xrb:6 1 ; newpar xrb:9 0.35 ; fit
# #### chisqr/dof = 4607/3769 = 1.222
#
# RESULT: unabsorbed kT ~ 0.24, absorbed kT ~ 0.50; nH ~ 1.1
# somewhat unusual but OK, I think acceptable; fit result matches
# result from last time, except kT was smaller...
# Sanity check, last time (Jan 26), fits gave:
#    unabs kT = 0.23 (range 0.215, 0.246)
#    abs kT = 0.37 (range 0.347, 0.424)
#    nH = 1.07 (range 0.992, 1.195)
#   0087940201 PN SP index was thawed for src region, but was basically 0.2
#   kind of locked into that.
#
# One extra step -- of course obvious risk of putting too much faith in
# old values when there's no meaning.  But want to understand _why_ fit is
# converging on new values; confirm that we haven't just missed the local
# minimum from before.
#
# newpar xrb:9 0.35 ; freeze xrb:9 ; fit
# #### chisqr/dof = 4611/3770 = 1.223
#
# thaw xrb:9 ; fit
# #### chisqr/dof = 4608.4/3769 = 1.22272
#
#  "FINAL" result:
#   2    2   apec       kT         keV      0.230699     +/-  6.42091E-03  
#   5    2   apec       norm                3.01010E-04  +/-  1.00281E-05  
#   6    3   TBabs      nH         10^22    1.08571      +/-  7.11689E-02  
#   7    4   powerlaw   PhoIndex            1.40000      frozen
#   9    5   apec       kT         keV      0.368469     +/-  1.86426E-02  
#  12    5   apec       norm                3.51294E-03  +/-  6.47144E-04 
#
# This fit is almost identical to the January 26 fit.
# SP indices agree to 3 decimal places.
# SNR model about the same (norm within 1%, nH within 1%), abundances agree to
#   2 decimal places (order ~0.1% discrepancy)
# Not looking closely but I think same applies to linse.
# OK.  main takeaway -- lots of settings work.
# the ERROR command is DEFINITELY underestimating the range of pssible fits.
# Since, e.g., I know that 
#    unabs kT ~ 0.25
#    abs kT ~ 0.50
#    nH ~ 1.1
# gives an equally good (in chi-squared, insignificantly better) fit.
# But, unabs kT 0.25 and abs kT 0.50 fall OUTSIDE the error range!
# As warned we do need to check results w/ steppar command.
# 
# =========================================================================

# Now mucking around manually to improve the fit
# 1. newpar xrb:2 0.2 ; freeze xrb:2; fit; thaw xrb:2
# chi-squared/dof after XRB unabsorbed apec kT pushed to fit near ~0.2 keV
# = 4595 / 3768 = 1.22

# 2. newpar xrb:9 0.35 ; freeze xrb:9; fit; thaw xrb:9
# chi-squared/dof after XRB absorbed apec kT pushed to fit near ~0.35 keV
# Result: just bounced back to 0.78 keV.  Really high, but maybe plausible...
# but, nH was insanely low (~0.1e22)
# = 4596 / 3768 = 1.22
#
# 3. newpar xrb:6 1 ; newpar xrb:9 0.35 ; fit ; thaw xrb:6,9 ; fit
# Result: OK, hovered around more reasonable values
# chi-squared/dof = 4608 / 3768 = 1.22

