# Script to fit source and background regions simultaneously
# for 0087940201 (all exposures) and 0551000201 (MOS1,2 only)

# Normalizations for instrumental lines hardcoded, entered by hand
# Background parameters hardcoded, entered by hand

#cpd /xw
setplot en
abund wilm
query yes

# Data import + response set-up (source)
# --------------------------------------

data 1:1 0087940201/odf/repro/mos1S001-src-grp50.pi 
data 2:2 0087940201/odf/repro/mos2S002-src-grp50.pi 
data 3:3 0087940201/odf/repro/pnS003-src-os-grp50.pi
data 4:4 0551000201/odf/repro/mos1S001-src-grp50.pi 
data 5:5 0551000201/odf/repro/mos2S002-src-grp50.pi 

resp 1 0087940201/odf/repro/mos1S001-src.rmf
resp 2 0087940201/odf/repro/mos2S002-src.rmf
resp 3 0087940201/odf/repro/pnS003-src.rmf
resp 4 0551000201/odf/repro/mos1S001-src.rmf
resp 5 0551000201/odf/repro/mos2S002-src.rmf

arf 1 0087940201/odf/repro/mos1S001-src.arf
arf 2 0087940201/odf/repro/mos2S002-src.arf
arf 3 0087940201/odf/repro/pnS003-src.arf
arf 4 0551000201/odf/repro/mos1S001-src.arf
arf 5 0551000201/odf/repro/mos2S002-src.arf

back 1 0087940201/odf/repro/mos1S001-src-qpb.pi
back 2 0087940201/odf/repro/mos2S002-src-qpb.pi
back 3 0087940201/odf/repro/pnS003-src-qpb.pi
back 4 0551000201/odf/repro/mos1S001-src-qpb.pi
back 5 0551000201/odf/repro/mos2S002-src-qpb.pi

# Data import + response set-up (background)
# ------------------------------------------

data 6:6 0087940201/odf/repro/mos1S001-bkg-grp50.pi
data 7:7 0087940201/odf/repro/mos2S002-bkg-grp50.pi
data 8:8 0087940201/odf/repro/pnS003-bkg-os-grp50.pi
data 9:9 0551000201/odf/repro/mos1S001-bkg-grp50.pi
data 10:10 0551000201/odf/repro/mos2S002-bkg-grp50.pi

resp 6 0087940201/odf/repro/mos1S001-bkg.rmf
resp 7 0087940201/odf/repro/mos2S002-bkg.rmf
resp 8 0087940201/odf/repro/pnS003-bkg.rmf
resp 9 0551000201/odf/repro/mos1S001-bkg.rmf
resp 10 0551000201/odf/repro/mos2S002-bkg.rmf

arf  6 0087940201/odf/repro/mos1S001-bkg.arf
arf  7 0087940201/odf/repro/mos2S002-bkg.arf
arf  8 0087940201/odf/repro/pnS003-bkg.arf
arf  9 0551000201/odf/repro/mos1S001-bkg.arf
arf 10 0551000201/odf/repro/mos2S002-bkg.arf

back 6 0087940201/odf/repro/mos1S001-bkg-qpb.pi
back 7 0087940201/odf/repro/mos2S002-bkg-qpb.pi
back 8 0087940201/odf/repro/pnS003-bkg-qpb.pi
back 9 0551000201/odf/repro/mos1S001-bkg-qpb.pi
back 10 0551000201/odf/repro/mos2S002-bkg-qpb.pi

# response set-up (background)
# ------------------------------------------

# 1: x-ray background
# 2: instrumental lines
# 3: SNR plasma model
# 4: soft proton background, background

## 0087940201 exposures, src region

# resp 1:1 0087940201/odf/repro/mos1S001-src.rmf
# arf  1:1 0087940201/odf/repro/mos1S001-src.arf
resp 2:1 0087940201/odf/repro/mos1S001-src.rmf
arf  2:1 0087940201/odf/repro/mos1S001-src-ff.arf
resp 3:1 0087940201/odf/repro/mos1S001-src.rmf
arf  3:1 0087940201/odf/repro/mos1S001-src.arf
resp 4:1 caldb/mos1-diag.rsp 
arf  4:1 none

# resp 1:2 0087940201/odf/repro/mos2S002-src.rmf
# arf  1:2 0087940201/odf/repro/mos2S002-src.arf
resp 2:2 0087940201/odf/repro/mos2S002-src.rmf
arf  2:2 0087940201/odf/repro/mos2S002-src-ff.arf
resp 3:2 0087940201/odf/repro/mos2S002-src.rmf
arf  3:2 0087940201/odf/repro/mos2S002-src.arf
resp 4:2 caldb/mos2-diag.rsp 
arf  4:2 none

# resp 1:3 0087940201/odf/repro/pnS003-src.rmf
# arf  1:3 0087940201/odf/repro/pnS003-src.arf
resp 2:3 0087940201/odf/repro/pnS003-src.rmf
arf  2:3 0087940201/odf/repro/pnS003-src-ff.arf
resp 3:3 0087940201/odf/repro/pnS003-src.rmf
arf  3:3 0087940201/odf/repro/pnS003-src.arf
resp 4:3 caldb/pn-diag.rsp 
arf  4:3 none

## 0551000201 exposures, src region

# resp 1:4 0087940201/odf/repro/mos1S001-src.rmf
# arf  1:4 0087940201/odf/repro/mos1S001-src.arf
resp 2:4 0551000201/odf/repro/mos1S001-src.rmf
arf  2:4 0551000201/odf/repro/mos1S001-src-ff.arf
resp 3:4 0551000201/odf/repro/mos1S001-src.rmf
arf  3:4 0551000201/odf/repro/mos1S001-src.arf
resp 4:4 caldb/mos1-diag.rsp 
arf  4:4 none

# resp 1:5 0087940201/odf/repro/mos2S002-src.rmf
# arf  1:5 0087940201/odf/repro/mos2S002-src.arf
resp 2:5 0551000201/odf/repro/mos2S002-src.rmf
arf  2:5 0551000201/odf/repro/mos2S002-src-ff.arf
resp 3:5 0551000201/odf/repro/mos2S002-src.rmf
arf  3:5 0551000201/odf/repro/mos2S002-src.arf
resp 4:5 caldb/mos2-diag.rsp 
arf  4:5 none

## 0087940201 exposures, bkg region

#resp 1:6 0087940201/odf/repro/mos1S001-bkg.rmf
#arf  1:6 0087940201/odf/repro/mos1S001-bkg.arf
resp 2:6 0087940201/odf/repro/mos1S001-bkg.rmf
arf  2:6 0087940201/odf/repro/mos1S001-bkg-ff.arf
resp 4:6 caldb/mos1-diag.rsp
arf  4:6 none

#resp 1:7 0087940201/odf/repro/mos2S002-bkg.rmf
#arf  1:7 0087940201/odf/repro/mos2S002-bkg.arf
resp 2:7 0087940201/odf/repro/mos2S002-bkg.rmf
arf  2:7 0087940201/odf/repro/mos2S002-bkg-ff.arf
resp 4:7 caldb/mos2-diag.rsp
arf  4:7 none

#resp 1:8 0087940201/odf/repro/pnS003-bkg.rmf
#arf  1:8 0087940201/odf/repro/pnS003-bkg.arf
resp 2:8 0087940201/odf/repro/pnS003-bkg.rmf
arf  2:8 0087940201/odf/repro/pnS003-bkg-ff.arf
resp 4:8 caldb/pn-diag.rsp
arf  4:8 none

## 0551000201 exposures, bkg region

#resp 1:9 0551000201/odf/repro/mos1S001-bkg.rmf
#arf  1:9 0551000201/odf/repro/mos1S001-bkg.arf
resp 2:9 0551000201/odf/repro/mos1S001-bkg.rmf
arf  2:9 0551000201/odf/repro/mos1S001-bkg-ff.arf
resp 4:9 caldb/mos1-diag.rsp
arf  4:9 none

#resp 1:10 0551000201/odf/repro/mos2S002-bkg.rmf
#arf  1:10 0551000201/odf/repro/mos2S002-bkg.arf
resp 2:10 0551000201/odf/repro/mos2S002-bkg.rmf
arf  2:10 0551000201/odf/repro/mos2S002-bkg-ff.arf
resp 4:10 caldb/mos2-diag.rsp
arf  4:10 none

# Model parameter set-up
# ----------------------
# Note: keep model definition + initial freeze/thaw commands together
# That way, easier to mentally link parameters and their numbers

# Sky X-ray background
# --------------------
# apec is: kT, abund, redshift, norm
model  1:xrb constant*(apec + tbabs(powerlaw + apec))
    1
    0.1
    1
    0
    2e-5
    1
    1.4
    1e-5
    0.25
    1
    0
    1e-4

# Apply background AREASCAL ratios to get XRB normalizations right
newpar xrb:1 0.983
newpar xrb:13 0.945
newpar xrb:25 0.978
newpar xrb:37 0.769
newpar xrb:49 0.779

# background constants tied to 1
newpar xrb:61 1
newpar xrb:73 1
newpar xrb:85 1
newpar xrb:97 1
newpar xrb:109 1

freeze xrb:1,13,25,37,49, 61,73,85,97,109

# Freeze key physical parameters to reasonable values:
# unabsorped apec kT (local hot bubble / heliospheric stuff), absorption nH,
# power-law index, and absorbed apec kT
freeze xrb:2,6,7,9


# XMM EPIC instrumental lines
# ---------------------------
model  2:instr con*(gauss + gauss + gauss + gauss + gauss + gauss)
    1
    1.49
    0
    0
    1.75
    0
    0
    7.49
    0
    0
    8.05
    0
    0
    8.62
    0
    0
    8.90
    0
    0

# Set MOS1 line normalizations (mos1 src, ff)
newpar instr:4 4.146e-2
newpar instr:7 1.285e-2
# Set MOS2 line constant, normalizations (mos2 src, ff)
newpar instr:20 1
newpar instr:23 4.531e-2
newpar instr:26 1.182e-2
# Set PN line constant, normalizations (pn src, ff); zero Si (1.75 keV) line
newpar instr:39 1
newpar instr:42 3.348e-2
newpar instr:45 0
newpar instr:48 1.236e-2
newpar instr:51 8.820e-2
newpar instr:54 1.850e-2
newpar instr:57 1.091e-2
# Set 0551000201 MOS1 line constant, norm (mos1 src, ff)
newpar instr:58 1
newpar instr:61 3.340e-2
newpar instr:64 2.004e-2
# Set 0551000201 MOS2 line constant, norm (mos1 src, ff)
newpar instr:77 1
newpar instr:80 3.866e-2
newpar instr:83 2.021e-2

# Set MOS1 line constant, normalizations (mos1 bkg, ff)
newpar instr:96 1
newpar instr:99 4.667e-2
newpar instr:102 8.893e-3
# Set MOS2 line constant, normalizations (mos2 bkg, ff)
newpar instr:115 1
newpar instr:118 4.975e-2
newpar instr:121 9.341e-3
# Set PN line constant, normalizations (pn bkg, ff); zero Si (1.75 keV) line
newpar instr:134 1
newpar instr:137 3.435e-2
newpar instr:140 0
newpar instr:143 1.511e-2
newpar instr:146 0.126
newpar instr:149 2.031e-2
newpar instr:152 1.653e-2

# Set MOS1(motch) line constant, normalizations (mos1 bkg, ff)
newpar instr:153 1
newpar instr:156 6.046e-2
newpar instr:159 3.386e-3
# Set MOS2(motch) line constant, normalizations (mos2 bkg, ff)
newpar instr:172 1
newpar instr:175 6.427e-2
newpar instr:178 5.218e-3

# Freeze all the line normalizations; let constant vary
# (essentially freezing all line ratios)
freeze instr:1-190
thaw instr:1,20,39,58,77, 96,115,134,153,172

# SUPERNOVA REMNANT
# -----------------
# 1 = TBabs nH
# 2 = vnei kT
# 3-15 = vnei abundances (H,He,C,...,Ni); 10=Si, 11=S
# 16 = vnei Tau
# 17 = vnei redshift
# 18 = vnei norm
mo 3:snr tbabs*vnei
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1
    1e11
    0
    1

# Hold to defaults for initial fit, before varying vnei/tbabs parameters
freeze snr:1,2,16

# Soft proton contamination
# -------------------------
# Don't link between instruments (per ESAS cookbook).
# At most, maybe we can link the power-law between MOS1 and MOS2
# But even then, because we're sampling different distances from optical axis
# etc., likely to differ.  So best to let float...
model 4:sp po*con
    0.4
    1e-2
    1

# For initial fit, don't let the power law index vary
newpar sp:1 0.4
newpar sp:4 0.4
newpar sp:7 0.4
newpar sp:10 0.4
newpar sp:13 0.4
newpar sp:16 0.4
newpar sp:19 0.4
newpar sp:22 0.4
newpar sp:25 0.4
newpar sp:28 0.4
freeze sp:1,4,7,10,13, 16,19,22,25,28

# Let all norms vary independently
newpar sp:2 1e-2
newpar sp:5 1e-2
newpar sp:8 1e-2
newpar sp:11 1e-2
newpar sp:14 1e-2
newpar sp:17 1e-2
newpar sp:20 1e-2
newpar sp:23 1e-2
newpar sp:26 1e-2
newpar sp:29 1e-2

# Apply background AREASCAL ratios to get normalizations right, in case we do
# fit with MOS/PN normalizations fixed from bkg region.
# In any case allows easier comparison of norm values as well
newpar sp:3 0.983
newpar sp:6 0.945
newpar sp:9 0.978
newpar sp:12 0.769
newpar sp:15 0.779
newpar sp:18 1
newpar sp:21 1
newpar sp:24 1
newpar sp:27 1
newpar sp:30 1
# constants should never be freed
freeze sp:3,6,9,12,15, 18,21,24,27,30

# TEST TODO TRIAL ERROR WARNING
# Try fixing PN power law normalizations based on background fits.
#newpar spm1:1 0.425
#newpar spm1:2 6.060e-2
#newpar spm2:1 0.421
#newpar spm2:2 6.446e-2
#newpar sppn:1 0.379
#newpar sppn:2 7.828e-2
#newpar spm1motch:1 0.534
#newpar spm1motch:2 2.976e-2
#newpar spm2motch:1 1.045
#newpar spm2motch:2 1.505e-2
#freeze spm1:*
#freeze spm2:*
#freeze sppn:*
#freeze spm1motch:*
#freeze spm2motch:*


# Prepare to fit
# --------------
notice all
ignore **:**-0.3,11.0-**
# Ignore 0.3-0.4 keV for PN
ignore 3:**-0.4
ignore 8:**-0.4

# xrb, 3 norms (apec, powerlaw, apec)
# instr lines, 10 constants
# soft proton, 10 norms
# SNR, 1 norm
renorm
# chi-squared/dof after renorm = 86300 / 3785? = ?

thaw sp:1,4,7,10,13,16,19,22,25,28
# tie MOS1/2 sp indices
newpar sp:4=sp:1
newpar sp:13=sp:10
newpar sp:19=sp:16
newpar sp:28=sp:25
# PN background index tends to blow up-- freeze to 0.2
newpar sp:22 0.2
freeze sp:22
fit
# chi-squared/dof after SP fit = 17762 / 3775 = 4.71

# Note: at this point, SP PN for background has an index that's going nuts

thaw snr:1,2,16
fit
# chi-squared/dof after fit with kT,nH,Tau free = 6924 / 3772 = 1.84
thaw snr:10,11
fit
# chi-squared/dof after fit with kT,nH,Tau,Si,S free = 4881 / 3770 = 1.29

thaw xrb:2,6,9
fit
# chi-squared/dof after fit with xrb free = 4630 / 3768 = 1.29
# (note, here I tied PN SP index)

# Now mucking around manually to improve the fit
# 1. newpar xrb:2 0.2 ; freeze xrb:2; fit; thaw xrb:2
# chi-squared/dof after XRB unabsorbed apec kT pushed to fit near ~0.2 keV
# = 4595 / 3768 = 1.22

# 2. newpar xrb:9 0.35 ; freeze xrb:9; fit; thaw xrb:9
# chi-squared/dof after XRB absorbed apec kT pushed to fit near ~0.35 keV
# Result: just bounced back to 0.78 keV.  Really high, but maybe plausible...
# but, nH was insanely low (~0.1e22)
# = 4596 / 3768 = 1.22
#
# 3. newpar xrb:6 1 ; newpar xrb:9 0.35 ; fit ; thaw xrb:6,9 ; fit
# Result: OK, hovered around more reasonable values
# chi-squared/dof = 4608 / 3768 = 1.22

